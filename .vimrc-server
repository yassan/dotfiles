"=========================================================
" 前提: vim-plug を使ったプラグイン管理
"---------------------------------------------------------
" まだ入れていなければ、シェルで以下を一度だけ実行:
" curl -fLo ~/.vim/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
"=========================================================

if &compatible
  set nocompatible
endif

" このファイル自体のエンコーディング
scriptencoding utf-8

"=========================================================
" プラグイン定義 (vim-plug)
"=========================================================
call plug#begin('~/.vim/plugged')

" --- 基本ユーティリティ ---
Plug 'tpope/vim-surround'        " 囲み文字操作 ((), {}, "", など)
Plug 'tpope/vim-commentary'      " gcc / gc{motion} でコメントトグル

" --- Git 連携 ---
Plug 'tpope/vim-fugitive'        " :Git, :Gdiff など Git 操作用

" --- ファイルツリー / ファイル検索 ---
Plug 'preservim/nerdtree'        " 左サイドのファイルツリー
Plug 'junegunn/fzf', { 'do': { -> fzf#install() } }   " FZF 本体 (バイナリも自動導入)
Plug 'junegunn/fzf.vim'          " :Files, :GFiles, :Buffers などの FZF 連携

" --- Lint, LSP, フォーマット (共通) ---
Plug 'dense-analysis/ale'        " 非同期 Lint + LSP クライアント

" --- 言語別強化 ---
Plug 'fatih/vim-go'              " Go 開発用 (gofmt, :GoTest 等)
Plug 'preservim/vim-markdown'    " Markdown 強化 (見出しや折り畳みなど)
Plug 'godlygeek/tabular'         " Markdown などで表をきれいに揃える

call plug#end()

"=========================================================
" 日本語・文字コード設定
"=========================================================
set encoding=utf-8            " Vim内部のエンコーディング
set fileencoding=utf-8        " 新規ファイルのデフォルト
set fileencodings=ucs-bom,utf-8,euc-jp,cp932
set fileformats=unix,dos,mac  " 改行コード検出

set helplang=ja,en
if has('multi_lang')
  silent! language messages ja_JP.utf-8
endif

" 日本語の曖昧幅文字を2桁扱いにしてレイアウト崩れを防ぐ
set ambiwidth=double

"=========================================================
" 表示・操作性
"=========================================================
" 行番号
" set number

" ステータスラインを常時表示
set laststatus=2

" ステータスライン内容（プラグインに依存しない）
set statusline=
set statusline=[%n]                           " バッファ番号
set statusline+=%{matchstr(hostname(),'\\w\\+')}@
set statusline+=%<%F                          " ファイルパス
set statusline+=%m                            " 変更フラグ
set statusline+=%r                            " 読み取り専用
set statusline+=%h                            " ヘルプ
set statusline+=%w                            " プレビュー
set statusline+=[%{&fileformat}]              " 改行コード
set statusline+=[%{&fileencoding!=''?&fileencoding:&encoding}]
set statusline+=%y                            " filetype
set statusline+=%=                            " ここから右寄せ
set statusline+=[ASCII=%B]                    " カーソル位置の文字コード
set statusline+=[C=%c/%{col('$')-1}]          " カラム / 最大カラム
set statusline+=[L=%l/%L]                     " 行番号 / 全行数
set statusline+=[%p%%]                        " ファイル内の割合

" カーソル行だけハイライト
set cursorline

" コマンド・カーソル位置を見やすく
set showcmd
set ruler

" スクロールの余白
set scrolloff=3
set sidescrolloff=5

" 反応速度 (CursorHold, ALE などに影響)
set updatetime=300

"=========================================================
" 検索
"=========================================================
set ignorecase      " 小文字検索で大文字もヒット
set smartcase       " 大文字を含む検索は区別
set hlsearch        " 検索結果をハイライト
set incsearch       " インクリメンタルサーチ

"=========================================================
" インデント・タブ
"=========================================================
set expandtab       " Tab を空白に展開
set shiftwidth=4    " 自動インデントの幅
set tabstop=4       " タブ幅
set softtabstop=4   " <Tab>入力時の見かけの幅

set autoindent
set smartindent

" 言語別のインデントは必要に応じて ftplugin 側に任せる

"=========================================================
" カラー・ハイライト
"=========================================================
if has('termguicolors')
  set termguicolors
endif

set background=dark
" 組み込み colorscheme を使い、Nerd Font 前提のテーマは避ける
silent! colorscheme desert

" vimdiff の色調整（組み込み Diff ハイライト上書き）
hi DiffAdd    ctermfg=black ctermbg=2
hi DiffChange ctermfg=black ctermbg=3
hi DiffDelete ctermfg=black ctermbg=6
hi DiffText   ctermfg=black ctermbg=7

"=========================================================
" マウス・クリップボード
"=========================================================
if has('mouse')
  set mouse=a      " すべてのモードでマウス有効
endif

" 端末クリップボードと連携（+clipboard ビルド前提）
if has('clipboard')
  set clipboard+=unnamedplus
endif

"=========================================================
" grep
"=========================================================
if executable('jvgrep')
  set grepprg=jvgrep
endif

"=========================================================
" filetype / syntax
"=========================================================
filetype plugin indent on
syntax enable

"=========================================================
" Markdown / YAML などの filetype 調整
"=========================================================
augroup my_filetypes
  autocmd!
  " Markdown 拡張子を markdown として扱う
  autocmd BufNewFile,BufRead *.{md,mdwn,mkd,mkdn,mark*} setlocal filetype=markdown

  " Markdown の italic 表示を LineNr と同じにして見やすく
  autocmd FileType markdown highlight! default link markdownItalic LineNr

  " YAML 系はインデントで fold 可能に（デフォルトでは fold 無効）
  autocmd BufNewFile,BufReadPost *.{yml,yaml,yml.liquid} setlocal foldmethod=indent nofoldenable
augroup END

"=========================================================
" キーマップ (Leader キーなど)
"=========================================================
let mapleader = " "         " <Space> を Leader に

" --- NERDTree ---
nnoremap <leader>e :NERDTreeToggle<CR>

" --- FZF (ファイル/バッファ検索) ---
nnoremap <leader>ff :Files<CR>        " カレントディレクトリからファイル検索
nnoremap <leader>fg :GFiles<CR>       " Git 管理ファイルから検索
nnoremap <leader>fb :Buffers<CR>      " 開いているバッファから検索
nnoremap <leader>fh :History<CR>      " 最近開いたファイルから検索

" --- Git (vim-fugitive) ---
nnoremap <leader>gs :Git<CR>
nnoremap <leader>gd :Gdiffsplit<CR>
nnoremap <leader>gb :Git blame<CR>

" --- コメントトグル (vim-commentary) ---
nnoremap <leader>/ :Commentary<CR>
xnoremap <leader>/ :Commentary<CR>

"=========================================================
" ALE (Lint / LSP / フォーマット)
"=========================================================
" サインの表示 (左端の列)
let g:ale_sign_error   = 'E'
let g:ale_sign_warning = 'W'
let g:ale_sign_column_always = 1

" いつ Lint するか
let g:ale_lint_on_text_changed = 'never'
let g:ale_lint_on_insert_leave = 1
let g:ale_lint_on_save         = 1

" 保存時に最低限の整形だけ実行 (外部コマンド不要)
let g:ale_fix_on_save = 1
let g:ale_fixers = {
\   '*': ['remove_trailing_lines', 'trim_whitespace'],
\}

" ALE による補完を有効化 (LSP サーバが入っていれば補完も効く)
let g:ale_completion_enabled = 1
set completeopt=menu,menuone,noselect

" ALE 用キーマップ
nnoremap <leader>al :ALELint<CR>
nnoremap <leader>an :ALENextWrap<CR>
nnoremap <leader>ap :ALEPreviousWrap<CR>
nnoremap <leader>ad :ALEDetail<CR>

" LSP 対応コマンド (対応サーバがあるときだけ有効に使える)
nnoremap <leader>hh :ALEHover<CR>
nnoremap <leader>rr :ALERename<CR>
nnoremap <leader>jd :ALEGoToDefinition<CR>
nnoremap <leader>jr :ALEFindReferences<CR>

"=========================================================
" Go 向け (vim-go)
"=========================================================
" 自動 gofmt/goimports は ALE や他のツールと競合しやすいので一旦 OFF
let g:go_fmt_autosave       = 0
let g:go_imports_autosave   = 0
let g:go_def_mapping_enabled = 0   " デフォルトの gd マッピングを潰さない

" よく使う Go コマンドのショートカット
augroup go_mappings
  autocmd!
  autocmd FileType go nnoremap <buffer> <leader>gt :GoTest<CR>
  autocmd FileType go nnoremap <buffer> <leader>gi :GoImport<CR>
  autocmd FileType go nnoremap <buffer> <leader>gf :GoFmt<CR>
augroup END

"=========================================================
" Markdown 向け (vim-markdown + tabular)
"=========================================================
" 折り畳みや自動リンクは好みに応じて必要最小限に
let g:vim_markdown_folding_disabled = 1
let g:vim_markdown_conceal = 0

" Markdown テーブル整形（vim-markdown 経由で Tabular を呼ぶ）
augroup markdown_mappings
  autocmd!
  autocmd FileType markdown nnoremap <buffer> <leader>ta :TableFormat<CR>
augroup END
